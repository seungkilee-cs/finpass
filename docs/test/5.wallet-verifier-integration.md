# Wallet ↔ Verifier Integration Runbook (M0.5)

This document validates **M0.5**: the Wallet can present a stored credential to the Verifier, receive a signed **decision token**, and store/display it.

What you will test:

- Wallet issues a credential (M0.3 path)
- Wallet calls Verifier:
  - `GET /verify/challenge`
  - `POST /verify`
- Wallet stores the returned `decisionToken` locally
- Wallet shows "✓ Verified" state for the credential

> Assumptions
> - Postgres via Docker Compose in repo root
> - Issuer runs on `http://localhost:8080`
> - Wallet runs on `http://localhost:3000`
> - Verifier runs on `http://localhost:8090`

---

## 0) Start Postgres

From repo root (`finpass/`):

```bash
docker compose up -d
```

Expected:
- Postgres container is running and exposing `15432`

---

## 1) Start Issuer (8080)

From `finpass/issuer`:

```bash
./mvnw -DskipTests spring-boot:run
```

Sanity check:

```bash
curl -s http://localhost:8080/.well-known/openid-credential-issuer
curl -s http://localhost:8080/jwks.json
```

Expected:
- Issuer metadata JSON contains `credential_endpoint_with_proof` and `jwks_uri`
- `jwks.json` returns `{ "keys": [ ... ] }`

---

## 2) Start Verifier (8090)

The verifier must trust the issuer public key to validate `commitmentJwt`.

From repo root (`finpass/`):

```bash
TRUSTED_ISSUER_PUBLIC_JWK="$(curl -s http://localhost:8080/jwks.json)" \
mvn -f verifier/pom.xml -DskipTests spring-boot:run
```

Expected:
- Verifier starts
- Logs show Tomcat listening on port `8090`

Sanity check:

```bash
curl -s http://localhost:8090/.well-known/openid-provider
curl -s http://localhost:8090/jwks.json
curl -s http://localhost:8090/verify/challenge
```

Expected:
- `.well-known/openid-provider` returns JSON (not 404)
- `/verify/challenge` returns `{ "challenge": "<uuid>", "expiresIn": 300 }`

---

## 3) Start Wallet (3000)

From `finpass/wallet`:

```bash
npm install
npm start
```

Open:
- `http://localhost:3000`

---

## 4) M0.5 Happy Path: Issue credential then Verify (UI)

### 4.1 Create/import wallet

1) Create a new wallet in the UI.
2) Confirm you saved the recovery phrase.

Expected:
- Dashboard shows "Your DID".

### 4.2 Issue a credential (Wallet → Issuer)

In **Get Passport Credential**:

- Name: `Alice`
- DOB: `1990-01-01`
- Country: `US`

Click **Get Credential**.

Expected:
- Credential appears in **Your Credentials** list.

### 4.3 Verify over 18 (Wallet → Verifier)

1) On the credential card, click **Details**.
2) Click **Prove Over 18**.
3) Confirm the browser dialog.

Expected:
- UI shows a green success block:
  - `✓ Verified (over_18)`
  - Assurance is `LOW`
  - Expiry time is displayed
- A **Copy decisionToken** button appears.
- Clicking **Copy decisionToken** copies a JWT to clipboard.

---

## 5) Verify persistence (Decision token storage)

1) Keep the credential expanded and click **Hide** then **Details** again.

Expected:
- It still shows `✓ Verified` (it is loaded from local storage if not expired).

2) Refresh the page.

Expected:
- Credential still exists.
- Expanding the credential shows `✓ Verified` (if token not expired).

---

## 6) Negative / edge tests

### 6.1 Wrong verifier URL

This is a quick way to confirm errors surface correctly.

1) Stop the verifier service OR change the verifier URL in code (if you want) to an unused port.
2) Click **Prove Over 18**.

Expected:
- UI shows a clear error message.

### 6.2 Token expiry triggers re-verification

Decision tokens expire after ~300 seconds by default.

1) Verify once successfully.
2) Wait 5+ minutes.
3) Click **Prove Over 18** again.

Expected:
- Wallet re-fetches a new challenge and re-verifies.
- UI shows `✓ Verified` again with a new expiry time.

### 6.3 Challenge replay protection (Verifier behavior)

Wallet always fetches a fresh challenge, so replay is hard to trigger from UI.
To test replay protection, use the M0.4 runbook and re-submit a `/verify` request with the same `challenge`.

Expected:
- `400` with message `Challenge already used`.

---

## Troubleshooting

### Verifier returns `Unknown challenge`

Cause:
- Challenge is single-use and stored in-memory.

Fix:
- Ensure the wallet calls `/verify` immediately after fetching `/verify/challenge`.
- Restarting the verifier invalidates previously minted challenges.

### Verifier returns `Invalid commitmentJwt`

Cause:
- Wallet/you sent the wrong token (e.g., pasted `credentialJwt` instead of `commitmentJwt`) or a truncated value.

Fix:
- Ensure the request uses the credential’s `commitmentJwt`.
