# M0.3 — Wallet ↔ Issuer Integration (Manual Testing Runbook)

This runbook validates **Milestone 0.3** end-to-end: a browser wallet generates a DID and Ethereum-style keypair, creates a **wallet proof signature**, sends it to the issuer, the issuer **verifies the proof** and issues a **JWT Verifiable Credential (JWT-VC)**, and the wallet **stores + displays** the credential.

## What M0.3 adds

### Wallet
- `wallet/src/core/CredentialHolder.ts`
  - Fetches issuer metadata from `/.well-known/openid-credential-issuer`
  - Builds a canonical `proofPayload`
  - Signs `proofPayload` using `ethers.Wallet.signMessage(...)`
  - Calls issuer `POST /issue-with-proof`
  - Stores returned VC in local storage
- `wallet/src/services/storage.ts`
  - Persists credentials (MVP encryption)
- UI
  - `wallet/src/ui/IssuanceFlow.tsx` (form + "Get Credential")
  - `wallet/src/ui/CredentialCard.tsx` (render + copy JWT)
  - `wallet/src/App.tsx` (wires issuance + list)

### Issuer
- `POST /issue-with-proof`
  - `issuer/src/main/java/com/finpass/issuer/controller/IssuerController.java`
  - `issuer/src/main/java/com/finpass/issuer/service/IssuerService.java`
- Proof verification
  - `issuer/src/main/java/com/finpass/issuer/util/WalletProofVerifier.java`
  - Recovers Ethereum address from `signMessage` signature (prefixed message)
  - Validates request binding:
    - `holderDid` in request == `holderDid` in proof
    - `holderAddress` in request == `holderAddress` in proof
    - `passportData` in request == `passportData` in proof
    - `proofPayload` must be canonical JSON

## Prerequisites
- Docker
- Node.js + npm
- Java 17

Assumed ports:
- Postgres: `15432` (host) → `5432` (container)
- Issuer: `8080`
- Wallet: `3000`

## 1) Start Postgres (Docker)

From repo root (`finpass/`):

```bash
docker compose up -d

docker ps --format "table {{.Names}}\t{{.Ports}}"
```

Expected: `finpass-postgres` shows `0.0.0.0:15432->5432/tcp`.

## 2) Start issuer backend

From `finpass/issuer`:

```bash
./mvnw -DskipTests spring-boot:run
```

### Quick issuer sanity checks

**Issuer metadata**

```bash
curl http://localhost:8080/.well-known/openid-credential-issuer
```

Expected JSON includes:
- `credential_endpoint`
- `credential_endpoint_with_proof`

**Issuer legacy issuance (optional)**

```bash
curl -X POST http://localhost:8080/issue \
  -H 'Content-Type: application/json' \
  -d '{
    "holderDid": "did:key:EXAMPLE",
    "passportData": {"name":"Alice","dob":"1990-01-01","country":"US"}
  }'
```

## 3) Start wallet frontend

From `finpass/wallet`:

```bash
npm install
npm start
```

Open:
- `http://localhost:3000`

## 4) End-to-end M0.3 test (UI)

1. **Create wallet**
   - Use the onboarding screen to create (or import) a wallet.

2. **Request a credential (proof-based)**
   - In **Get Passport Credential** fill:
     - Name: `Alice`
     - DOB: `1990-01-01`
     - Country: `US`
   - Click **Get Credential**.

3. **Validate UI updated**
   - A new card should appear under **Your Credentials**.
   - Expand details (if present) and copy the `credentialJwt`.

4. **Validate persistence**
   - Refresh the page.
   - Credential should remain in **Your Credentials**.

5. **Validate issuer status endpoint**
   - Copy `credId` from the card.
   - Run:

```bash
curl http://localhost:8080/status/<credId>
```

Expected: status JSON such as `{ "credId": "...", "status": "ISSUED" }`.

## 5) Negative tests (issuer validation)

These confirm the issuer is really validating the wallet proof.

### A) Invalid signature should fail

```bash
curl -i -X POST "http://localhost:8080/issue-with-proof" \
  -H "Content-Type: application/json" \
  -d '{
    "holderDid":"did:key:EXAMPLE",
    "passportData":{"name":"Alice","dob":"1990-01-01","country":"US"},
    "holderAddress":"0x0000000000000000000000000000000000000000",
    "proofPayload":"{\"holderAddress\":\"0x0000000000000000000000000000000000000000\",\"holderDid\":\"did:key:EXAMPLE\",\"passportData\":{\"country\":\"US\",\"dob\":\"1990-01-01\",\"name\":\"Alice\"},\"timestamp\":\"2025-01-01T00:00:00.000Z\"}",
    "proofSignature":"0x00"
  }'
```

Expected: HTTP `400`.

### B) Request/proof binding mismatch should fail

Example: change request `holderDid` but keep proofPayload `holderDid` the same.

```bash
curl -i -X POST "http://localhost:8080/issue-with-proof" \
  -H "Content-Type: application/json" \
  -d '{
    "holderDid":"did:key:MISMATCH",
    "passportData":{"name":"Alice","dob":"1990-01-01","country":"US"},
    "holderAddress":"0x0000000000000000000000000000000000000000",
    "proofPayload":"{\"holderAddress\":\"0x0000000000000000000000000000000000000000\",\"holderDid\":\"did:key:EXAMPLE\",\"passportData\":{\"country\":\"US\",\"dob\":\"1990-01-01\",\"name\":\"Alice\"},\"timestamp\":\"2025-01-01T00:00:00.000Z\"}",
    "proofSignature":"0x00"
  }'
```

Expected: HTTP `400` (holderDid mismatch).

## Troubleshooting

### Wallet shows “Failed to issue credential”
- Ensure issuer is running on `http://localhost:8080`.
- Ensure the issuer metadata endpoint responds.
- Check the issuer console logs for validation errors.

### Issuer fails to start: "Port 8080 was already in use"

Find what's using `8080`:

```bash
lsof -nP -iTCP:8080 -sTCP:LISTEN
```

If it's an old issuer instance, stop it (use the PID from `lsof`):

```bash
kill <PID>
```

If it won’t stop, you can force kill:

```bash
kill -9 <PID>
```

Alternative: run issuer on a different port (example `8081`):

```bash
./mvnw -DskipTests spring-boot:run -Dspring-boot.run.arguments=--server.port=8081
```

If you do this, make sure the wallet points to the new issuer URL (currently `wallet/src/App.tsx` uses `http://localhost:8080`).

### CORS issues
- If the browser blocks requests, confirm the issuer has CORS enabled (or run wallet via a proxy). If needed, we can add explicit Spring CORS config.

### IDE Java package warnings
Some IDEs may show package/source-root mismatch warnings (e.g. `main.java...`). If Maven builds and the service runs, it’s safe to ignore. Fix by reimporting the Maven project and marking `issuer/src/main/java` as a sources root.


-----


Output logs

Quick issuer checks
```
❯ curl http://localhost:8080/.well-known/openid-credential-issuer
{"issuer_did":"did:example:issuer","credential_endpoint":"http://localhost:8080/issue","credential_endpoint_with_proof":"http://localhost:8080/issue-with-proof","credential_configurations_supported":{"PassportCredential":{"cryptographic_binding_methods_supported":["did"],"format":"jwt_vc","credential_signing_alg_values_supported":["EdDSA"],"scope":"passport_credential"}}}%   
```

credentials are created
```
Passport Credential
Alice · US · 1990-01-01
Status: valid
credId: d88b3f41-7fd7-4559-8557-b832215ebabc
issuerDid: did:example:issuer
commitmentHash: 537ab0594632117f2478e006c691745dfa1ebbf6a1d86b8ce7bb7ded1697588d
```

issuer status endpoint
```
❯ curl http://localhost:8080/status/d88b3f41-7fd7-4559-8557-b832215ebabc
{"credId":"d88b3f41-7fd7-4559-8557-b832215ebabc","status":"valid"}%     
```