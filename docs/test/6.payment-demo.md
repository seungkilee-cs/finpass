# Payment Demo Runbook (M0.6)

This document validates **M0.6**: a payment intent is created, KYC is attached via a verifier-issued `decisionToken` (PoC claim: `over_18`), and the payment is confirmed with an in-memory ledger update.

Services and ports:

- Postgres: `15432` (docker)
- Issuer: `http://localhost:8080`
- Verifier + Payment API: `http://localhost:8090`
- Wallet UI: `http://localhost:3000`

---

## 0) Start Postgres

From repo root (`finpass/`):

```bash
docker compose up -d
```

Expected:
- Postgres is running

---

## 1) Start Issuer (8080)

From `finpass/issuer`:

```bash
./mvnw -DskipTests spring-boot:run
```

Sanity:

```bash
curl -s http://localhost:8080/.well-known/openid-credential-issuer
curl -s http://localhost:8080/jwks.json
```

Expected:
- `jwks.json` returns `{ "keys": [ ... ] }`

---

## 2) Start Verifier + Payment API (8090)

Verifier needs the issuer public JWKS for verifying `commitmentJwt` during M0.5 verification, and it also hosts the M0.6 payment API.

From repo root (`finpass/`):

```bash
TRUSTED_ISSUER_PUBLIC_JWK="$(curl -s http://localhost:8080/jwks.json)" \
mvn -f verifier/pom.xml -DskipTests spring-boot:run
```

Sanity:

```bash
curl -s http://localhost:8090/.well-known/openid-provider
curl -s http://localhost:8090/verify/challenge
```

Expected:
- `verify/challenge` returns `{ "challenge": "<uuid>", "expiresIn": 300 }`

Payment API sanity:

```bash
curl -s http://localhost:8090/payments/balance/did:example:test
```

Expected:
- JSON includes `did` and `balance`

---

## 3) Start Wallet (3000)

From `finpass/wallet`:

```bash
npm install
npm start
```

Open:
- `http://localhost:3000`

---

## 4) UI happy path (recommended)

### 4.1 Create/import wallet

Expected:
- Dashboard shows your wallet DID.

### 4.2 Issue a credential (Wallet → Issuer)

Use **Get Passport Credential**:

- Name: `Alice`
- DOB: `1990-01-01`
- Country: `US`

Expected:
- A credential appears in **Your Credentials**.

### 4.3 Make a payment (Wallet → Payment API)

In **Payments (M0.6)**:

1) Set **Receiver DID** to any DID different from your own (example):
   - `did:key:RECEIVER_EXAMPLE`
2) Set **Amount** (example):
   - `10`
3) Click **Create Intent**.

Expected:
- A message like `Payment intent created`
- The intent line shows an ID and status `CREATED`

4) Click **Attach KYC (over_18)**.

Expected:
- If you already have a valid decision token stored, it is reused.
- Otherwise, the wallet runs M0.5 verification first and then attaches the decision token.
- A message like `KYC attached`
- Intent status becomes `KYC_VERIFIED`

5) Click **Confirm Payment**.

Expected:
- A message like `Payment confirmed`
- Intent status becomes `CONFIRMED`
- Balances update:
  - payer decreases by `amount`
  - receiver increases by `amount`

---

## 5) API-only testing (curl)

These steps let you validate the M0.6 API without the wallet UI.

### 5.1 Create an intent

```bash
curl -s -X POST http://localhost:8090/payments/intents \
  -H 'Content-Type: application/json' \
  -d '{
    "payerDid": "did:key:EXAMPLE_PAYER",
    "receiverDid": "did:key:EXAMPLE_RECEIVER",
    "amount": 10
  }'
```

Expected:
- `intentId`
- `status: "CREATED"`

### 5.2 Attach KYC

You need a valid `decisionToken` issued by the verifier for `sub == payerDid` and containing `verified_claims` with `over_18`.

```bash
curl -s -X POST http://localhost:8090/payments/<INTENT_ID>/verify-kyc \
  -H 'Content-Type: application/json' \
  -d '{
    "decisionToken": "<DECISION_TOKEN>"
  }'
```

Expected:
- `status: "KYC_VERIFIED"`

### 5.3 Confirm

```bash
curl -s -X POST http://localhost:8090/payments/<INTENT_ID>/confirm
```

Expected:
- `status: "CONFIRMED"`
- `payerBalance` and `receiverBalance` updated

---

## 6) Negative tests

### 6.1 Confirm without KYC

1) Create an intent.
2) Immediately call `POST /payments/<INTENT_ID>/confirm`.

Expected:
- `400` error with message like `KYC verification required before confirm`

### 6.2 Attach invalid decision token

Attach a random string:

Expected:
- `400` with message like `Invalid decision token`

### 6.3 Decision token subject mismatch

Attach a valid decision token whose `sub` is not the intent `payerDid`.

Expected:
- `400` with message `Decision token subject must match payerDid`

### 6.4 Missing required claim

Attach a valid decision token that does not contain `over_18`.

Expected:
- `400` with message `Decision token missing required claim: over_18`

---

## Troubleshooting

### CORS errors in browser

The payment API is hosted on the verifier app and uses permissive CORS.
If you still see CORS issues, confirm the API is on `http://localhost:8090`.

### `Invalid decision token signature`

Cause:
- The verifier was restarted and generated a new signing key.

Fix:
- Re-run verification in the wallet to obtain a fresh decision token.
